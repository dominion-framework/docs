<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dominion - Node.js framework for creating REST APIs</title>
    <meta content="width=device-width, initial-scale=1.0,minimum-scale=1.0,user-scalable=yes" name="viewport" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="manifest" href="/assets/site.webmanifest">
    <link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <link href="/assets/style.css" type="text/css" rel="stylesheet" />
    <script src="/assets/clipboard.min.js" async></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-97343130-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-97343130-2');
    </script>
</head>
<body>
<div class="doc-page">
    <nav class="menu toc-menu">
        <button class="menu-toggle-button" onclick="document.querySelector('.toc-menu div.collapsible').classList.toggle('open')">
            <div class="menu-toggle"></div>
        </button>
        <div class="menu-item logo">
            <a class="link active" href="/"><img src="/assets/logo.svg" /></a>
        </div>
        <div class="collapsible">
            <div class="links">
                <a href="https://www.npmjs.com/package/@dominion-framework/dominion" style="width: 32px;">
                    <svg viewBox="0 0 256 100" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMin meet"><path d="M0 0v85.498h71.166V99.83H128V85.498h128V0H0z" fill="#000"/><path d="M42.502 14.332h-28.17v56.834h28.17V28.664h14.332v42.502h14.332V14.332H42.502zM85.498 14.332v71.166h28.664V71.166h28.17V14.332H85.498zM128 56.834h-13.838v-28.17H128v28.17zM184.834 14.332h-28.17v56.834h28.17V28.664h14.332v42.502h14.332V28.664h14.332v42.502h14.332V14.332h-57.328z" fill="#FFF"/></svg>
                </a>
                <a href="https://gitter.im/dominion-framework/community">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50"><path d="M10 2a1 1 0 0 0-1 1v27a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1h-4zm9 7a1 1 0 0 0-1 1v37a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1V10a1 1 0 0 0-1-1h-4zm9 0a1 1 0 0 0-1 1v37a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1V10a1 1 0 0 0-1-1h-4zm9 0a1 1 0 0 0-1 1v20a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1V10a1 1 0 0 0-1-1h-4z"/></svg>
                </a>
                <a href="https://github.com/dominion-framework/dominion">
                    <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m256 0c-140.609375 0-256 115.390625-256 256 0 119.988281 84.195312 228.984375 196 256v-84.695312c-11.078125 2.425781-21.273438 2.496093-32.550781-.828126-15.128907-4.464843-27.421875-14.542968-36.546875-29.910156-5.816406-9.8125-16.125-20.453125-26.878906-19.671875l-2.636719-29.882812c23.253906-1.992188 43.371093 14.167969 55.3125 34.230469 5.304687 8.921874 11.410156 14.152343 19.246093 16.464843 7.574219 2.230469 15.707032 1.160157 25.183594-2.1875 2.378906-18.972656 11.070313-26.074219 17.636719-36.074219v-.015624c-66.679687-9.945313-93.253906-45.320313-103.800781-73.242188-13.976563-37.074219-6.476563-83.390625 18.238281-112.660156.480469-.570313 1.347656-2.0625 1.011719-3.105469-11.332032-34.230469 2.476562-62.546875 2.984375-65.550781 13.078125 3.867187 15.203125-3.890625 56.808593 21.386718l7.191407 4.320313c3.007812 1.792969 2.0625.769531 5.070312.542969 17.371094-4.71875 35.683594-7.324219 53.726563-7.558594 18.179687.234375 36.375 2.839844 54.464844 7.75l2.328124.234375c-.203124-.03125.632813-.148437 2.035157-.984375 51.972656-31.480469 50.105469-21.191406 64.042969-25.722656.503906 3.007812 14.128906 31.785156 2.917968 65.582031-1.511718 4.65625 45.058594 47.300781 19.246094 115.753906-10.546875 27.933594-37.117188 63.308594-103.796875 73.253907v.015624c8.546875 13.027344 18.816406 19.957032 18.761719 46.832032v105.722656c111.808594-27.015625 196-136.011719 196-256 .003906-140.609375-115.386719-256-255.996094-256zm0 0"/></svg>
                </a>
            </div>
            <ul>
                <li class="menu-item">
                    <a class="link" href="/quick-start">Quick start</a>
                </li>
                <li class="menu-item">
                    <a class="link" href="/components">Components</a>
                </li>
                <li class="menu-item">
                    <a class="link" href="#api-request-lifecycle">API Request Lifecycle</a>
                </li>
                <li class="menu-item">
                    <a class="link" href="#controller">Controller</a>
                </li>
                <li class="menu-item">
                    <a class="link" href="#models">Models</a>
                </li>
                <li class="menu-item">
                    <a class="link" href="#repositories">Repositories</a>
                </li>
                <li class="menu-item">
                    <a class="link" href="#interceptors">Interceptors</a>
                </li>
                <li class="menu-item">
                    <a class="link" href="/annotations">Annotations</a>
                    <ul class="submenu">
                        <li class="menu-item"><a class="link" href="#available-settings">@path</a>
                        </li>
                        <li class="menu-item"><a class="link" href="#plugins">@summary</a>
                        </li>
                        <li class="menu-item"><a class="link" href="#installing-markdown-plugins">@description</a>
                        </li>
                        <li class="menu-item"><a class="link" href="#bundled-plugins">@model</a>
                        </li>
                        <li class="menu-item"><a class="link" href="#bundled-plugins">@deprecated</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>
    <div class="markdown-body"><p><img src="./assets/logo.svg" alt="Dominion node rest api framework logo"></p>
<p>Dominion is declarative Promise based Node.js framework for REST API</p>
<h3>API Request Lifecycle</h3>
<p>To understand how requests are processed lets look on their lifecycle, it’s straight forward:</p>
<ol>
<li>
<p>On startup framework goes through all registered controllers (<code>core/controllers/index.js</code>), generates URL based
on functions interface and make mappings between URL’s and those functions.</p>
</li>
<li>
<p>Client makes request to API server.</p>
</li>
<li>
<p>Framework’s router (<code>core/router/index.js</code>) catches the request and looking
for matching callback from ones registered in controllers.</p>
</li>
<li>
<p>If match was founded router builds request Promise chain. A chain contains
<em>request interceptors</em>,  <em>handler</em> (function defined in controller), <em>response interceptors</em>
and <em>request finalisation</em>. Then request promise chain gets executed:</p>
<ol>
<li>Requests interceptors are taking from <code>requestInterceptors</code> array in component’s
declaration file (<code>index.js</code>). They are general purpose functions that may validate
client’s authorization.</li>
<li>Then <code>handler</code> gets executed. It defines top level business logic.
Usually controller’s <code>handler</code> manipulates models created by <code>Factories</code>.
If needed, factories or model instances call linked <code>Repository</code>
to create/modify/remove data in DB.</li>
<li>Result of <code>handler</code> execution is passed to response interceptors. They are taking
from <code>responseInterceptors</code> array in component’s declaration file. There are no common use
for response interceptor, as <code>handler</code> is responsible to produce response that is
ready to be send back to client. However, it may be used to perform some general actions
that depends on <code>handler</code>'s response, like set custom header.</li>
<li>Lastly, router handles common exceptions produced by <code>Repositoy</code> or <code>Factories</code> and sets
proper status code (400 - for bad request, 404 - if model not found, 409 - for conflicts, etc).</li>
</ol>
</li>
<li>
<p>And finally, response produced by all previous steps gets stringified and returned to a client.</p>
</li>
</ol>
<h3>Controller</h3>
<p>File containing controller should export object with a list of request <code>handler</code> functions and some
meta data. This object may have properties:</p>
<p><code>path</code> - domain part of an URL. Note, domain part is the last section of URL,
for example if controller returns models from <code>Users</code> domain,
urls can be <code>https://example.com/users</code>, <code>https://example.com/departments/42/users</code>.</p>
<p><code>permissions</code> - array of permissions that are required by all <code>handler</code>'s in the controller.</p>
<p><code>GET</code> <code>POST</code> <code>PUT</code> <code>DELETE</code> <code>OPTIONS</code> <code>WS</code> - arrays containing <code>handler</code> functions for requests
with specific http verbs or web sockets.</p>
<pre class="hljs"><button data-clipboard-target="#_748" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_748"><span class="hljs-keyword">const</span> Factories                 = use(<span class="hljs-string">"core/factories"</span>);

<span class="hljs-keyword">const</span> UsersFactory              = Factories(<span class="hljs-string">"Users"</span>);

<span class="hljs-built_in">module</span>.exports = {

    <span class="hljs-attr">path</span>: UsersFactory.__model__.name, <span class="hljs-comment">// "users"</span>

    permissions: {
        <span class="hljs-attr">POST</span>:   <span class="hljs-string">"Users.Create"</span>,
        <span class="hljs-attr">PUT</span>:    <span class="hljs-string">"Users.Update"</span>,
        <span class="hljs-attr">DELETE</span>: <span class="hljs-string">"Users.Delete"</span>
    },

    <span class="hljs-attr">GET</span>: [
        <span class="hljs-comment">// users/?limit=6&amp;offset=12</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">limit = <span class="hljs-number">6</span>, offset = <span class="hljs-number">12</span></span>) </span>{
            <span class="hljs-comment">// @summary: Get all user with pagination</span>
            <span class="hljs-keyword">return</span> UsersFactory.find();
        },

        <span class="hljs-comment">// users/42</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">usersId</span>) </span>{
            <span class="hljs-comment">// @permission: Users.Read</span>
            <span class="hljs-comment">// @summary: Get user instance by id</span>
            <span class="hljs-keyword">return</span> UsersFactory.get({<span class="hljs-attr">id</span>: usersId});
        }
    ],

    <span class="hljs-attr">POST</span>: [
        <span class="hljs-comment">// users/</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-comment">// @summary: Create new user</span>
            <span class="hljs-keyword">return</span> UsersFactory.new(<span class="hljs-keyword">this</span>.request.body)
                .then(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.save())
                .then(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.sendInvitationEmail())
                .then(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> UsersFactory.get({<span class="hljs-attr">id</span>: user.id}));
        }
    ],

    <span class="hljs-attr">PUT</span>: [
        <span class="hljs-comment">// users/42</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">usersId</span>) </span>{
            <span class="hljs-comment">// @summary: Update new user profile</span>
            <span class="hljs-keyword">return</span> UsersFactory.get({<span class="hljs-attr">id</span>: usersId})
                .then(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.populate(<span class="hljs-keyword">this</span>.request.body))
                .then(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.save());
        }
    ],

    <span class="hljs-attr">DELETE</span>: [
        <span class="hljs-comment">// users/1</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">usersId</span>) </span>{
            <span class="hljs-comment">// @summary: Remove user by id</span>
            <span class="hljs-keyword">return</span> UsersFactory.get({<span class="hljs-attr">id</span>: usersId})
                .then(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.remove())
                .then(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
                    <span class="hljs-keyword">if</span> (result.affectedRows) {
                        <span class="hljs-keyword">this</span>.response.status = <span class="hljs-keyword">this</span>.response.statuses._204_NoContent;
                    }
                });
        }
    ]
};
</code></pre>
<h4>URL generation</h4>
<p>URL for API’s endpoints is generated automatically from <code>handler</code> function interface (arguments list)
based on following rules:</p>
<ol>
<li>Property <code>path:</code> from controller declaration is always the last section of URL.</li>
</ol>
<pre class="hljs"><button data-clipboard-target="#_mjo" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_mjo">{
    <span class="hljs-attr">path</span>: <span class="hljs-string">"books"</span>,
    ...
    GET: [
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ }

        <span class="hljs-comment">// produces URL: </span>
        <span class="hljs-comment">// https://example.com/books    </span>
    ]

}
</code></pre>
<ol start="2">
<li>Function’s required arguments are used for path part of URL. If argument name equals to
declaration’s <code>path:</code> property it is used as model identified in URL:</li>
</ol>
<pre class="hljs"><button data-clipboard-target="#_170" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_170">{
    <span class="hljs-attr">path</span>: <span class="hljs-string">"books"</span>
    ...
    GET: [
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">booksId</span>) </span>{ }

        <span class="hljs-comment">// produces URL: </span>
        <span class="hljs-comment">// https://example.com/books/42    </span>
    ]

}
</code></pre>
<ol start="3">
<li>If argument name is not equal to declaration’s <code>path:</code> property it is used as model’s
parent identified in URL. Identifiers from URL will be passed to function
when it will be called. In following example, during execution <code>shelvesId</code> == 42 and <code>booksId</code> == 21:</li>
</ol>
<pre class="hljs"><button data-clipboard-target="#_2np9" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_2np9">{
    <span class="hljs-attr">path</span>: <span class="hljs-string">"books"</span>
    ...
    GET: [
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">shelvesId, booksId</span>) </span>{ }

        <span class="hljs-comment">// produces URL: </span>
        <span class="hljs-comment">// https://example.com/shelves/42/books/21    </span>
    ]

}
</code></pre>
<ol start="4">
<li>Function’s optional arguments are treated as query parameters (section of URL after “?”).</li>
</ol>
<pre class="hljs"><button data-clipboard-target="#_4epg" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_4epg">{
    <span class="hljs-attr">path</span>: <span class="hljs-string">"books"</span>
    ...
    GET: [
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">limit = <span class="hljs-number">6</span>, offset = <span class="hljs-number">0</span></span>) </span>{ }

        <span class="hljs-comment">// produces URL: </span>
        <span class="hljs-comment">// https://example.com/books?limit=12&amp;offset=0    </span>
    ]

}
</code></pre>
<ol start="5">
<li>
<p>If names of required arguments has ‘Id’ suffix (e.g. <code>booksId</code>) it will be ignored in URL.</p>
</li>
<li>
<p>If requested URL will not match any of existing handlers, server will respond <code>501 Not Implemented</code>.</p>
</li>
</ol>
<p>Note, all values extracted from URL are strings, consequently arguments in
<code>handler</code> functions also are always <code>String</code> type.</p>
<h4>API Handlers</h4>
<p><code>Handler</code> function is executing with HTTP message context (<code>core/messages/index.js</code>).
In other word, <code>this</code> point to object containing information about HTTP request and response.</p>
<pre class="hljs"><button data-clipboard-target="#_24lb" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_24lb"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">booksId</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.request.body);
    
    <span class="hljs-keyword">this</span>.response.headers[<span class="hljs-string">"X-Items-Length"</span>] = <span class="hljs-number">42</span>;
}
</code></pre>
<h4>Annotations</h4>
<p>Annotation comments are declared inside <code>handler</code> functions. They can be used to add
some meta information to an endpoint.</p>
<p>For example, <code>@path:</code> annotation can be used to change auto-generated URL of an endpoint:</p>
<pre class="hljs"><button data-clipboard-target="#_im2" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_im2"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">// @path: /auth/token</span>
    
    <span class="hljs-keyword">return</span> UsersFactory.get({<span class="hljs-attr">email</span>: <span class="hljs-keyword">this</span>.request.body.email})
        .then(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.validatePassword(<span class="hljs-keyword">this</span>.request.body.password))
        .then(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.createAuthToken())
}
</code></pre>
<h3>Models</h3>
<p>Files containing models declaration should export object with model’s properties and
prototypes for models factories and models instances.</p>
<p>Models declaration object has following properties:</p>
<p><code>name</code> - model’s name. Good practice is to keep model’s name always in plural to avoid ambiguity.</p>
<p><code>repository</code> - optional, link to model’s <code>Repository</code>.</p>
<p><code>properties</code> - object containing model’s properties. Object keys will be properties’ names, values - properties validators.</p>
<p><code>factory</code> - object containing functions that will be used as model’s factory prototype.</p>
<p><code>instance</code> - object containing functions that will be used as model’s instance prototype.</p>
<pre class="hljs"><button data-clipboard-target="#_1d0" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_1d0"><span class="hljs-keyword">const</span> Property                  = use(<span class="hljs-string">"core/property"</span>);
<span class="hljs-keyword">const</span> Errors                    = use(<span class="hljs-string">"core/errors"</span>);

<span class="hljs-keyword">const</span> UsersRepository           = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./repository"</span>);


<span class="hljs-built_in">module</span>.exports = {

    <span class="hljs-attr">name</span>: <span class="hljs-string">"Users"</span>,

    <span class="hljs-attr">repository</span>: UsersRepository, 

    <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">id</span>: Property.id(),
        <span class="hljs-attr">phoneNumber</span>: Property.number().min(<span class="hljs-number">100000000000</span>).max(<span class="hljs-number">999999999999</span>),
        <span class="hljs-attr">email</span>: Property.string().pattern(<span class="hljs-regexp">/\S+@\S\(.\S)+/</span>).max(<span class="hljs-number">100</span>),
        <span class="hljs-attr">passwordHash</span>: Property.string().max(<span class="hljs-number">255</span>).private(),
        <span class="hljs-attr">passwordSalt</span>: Property.string().max(<span class="hljs-number">255</span>).private(),
        <span class="hljs-attr">creationTime</span>: Property.date().private(),
        <span class="hljs-attr">modificationTime</span>: Property.date().private()
    },

    <span class="hljs-attr">factory</span>: {

        getActiveUsers(limit = <span class="hljs-number">6</span>, offset = <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.repo.getActiveUsers(limit, offset)
                .then(<span class="hljs-function"><span class="hljs-params">users</span> =&gt;</span> <span class="hljs-built_in">Promise</span>.all(users.map(<span class="hljs-function"><span class="hljs-params">mix</span> =&gt;</span> <span class="hljs-keyword">this</span>.new(mix, <span class="hljs-literal">false</span>))));
        }

    },

    <span class="hljs-attr">instance</span>: {

        checkPassword(password) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.passwordHash === createHash(password, <span class="hljs-keyword">this</span>.passwordSalt)) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Errors.Unauthorized(<span class="hljs-string">"Incorrect credentials"</span>);
            }
        },

        setPassword(password) {
            <span class="hljs-keyword">let</span> [passwordHash, passwordSalt] = hash(password);
            <span class="hljs-keyword">this</span>.populate({passwordHash, passwordSalt});
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }
    }
};
</code></pre>
<h4>Factory Prototype</h4>
<p>Default factory prototype (<code>core/factories/modelFactoryPrototype.js</code>) has methods:</p>
<p><code>.new( [modelData] )</code></p>
<p>Creates new instance of model. Object with initial model’s data can be passed as argument.</p>
<p><code>.get( [criteriasObject] )</code></p>
<p>Fetches one record from DB using <code>criteriasObject</code> and returns model’s instance
containing it. This method requires <code>repository:</code> to be defined in model declaration.</p>
<p>For example:</p>
<pre class="hljs"><button data-clipboard-target="#_b7f" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_b7f">UsersFactory.get({<span class="hljs-attr">id</span>: <span class="hljs-number">42</span>})
</code></pre>
<p><code>.find([criteriasObject], [limit], [offset], [order])</code></p>
<p>Fetch collection with <code>limit</code> records using <code>criteriasObject</code>  starting from <code>offset</code>
in <code>order</code>, where order is a string equals to one of model’s properties name and
prefixed by “+” or “-” for ascend or descend sorting. Returns array with model’s instance.
This method requires <code>repository:</code> to be defined in model declaration.</p>
<p>For example:</p>
<pre class="hljs"><button data-clipboard-target="#_2o0l" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_2o0l">UsersFactory.find({<span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"active"</span>}, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-string">"+last_name"</span>)
</code></pre>
<h4>Instance Prototype</h4>
<p>Default instance prototype (<code>core/factories/modelPrototype.js</code>) has methods:</p>
<p><code>.populate( {modelsData} )</code></p>
<p>Populates model’s properties from object provided in <code>modelsData</code>. Before assigning
provided values are validated to match <code>Property</code> rules from models declaration.
For example:</p>
<pre class="hljs"><button data-clipboard-target="#_10lc" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_10lc"><span class="hljs-comment">//model's property declaration:</span>
properties: {
    <span class="hljs-attr">id</span>: Property.id(),
    <span class="hljs-attr">isbn</span>: Property.string().pattern(<span class="hljs-regexp">/^ISBN \d-\d{3}-\d{5}-\d$/</span>)
}

...

<span class="hljs-comment">//models instance:</span>

book.populate( {<span class="hljs-attr">isbn</span>: <span class="hljs-string">"2000"</span>} ); 
<span class="hljs-comment">// throws error, because "2000" doesn't match regexp /^ISBN \d-\d{3}-\d{5}-\d$/</span>

<span class="hljs-comment">// the same applies during direct assignment</span>
book.isbn = <span class="hljs-string">"2000"</span>
</code></pre>
<p><code>.validate()</code></p>
<p>Validates all model’s properties to match <code>Property</code> rules from model’s properties declaration.</p>
<p><code>.toJSON()</code></p>
<p>Stringifies model before sending it back to client. It applies <code>Property</code> rules and output
modifications from model’s properties declaration. Can be reloaded if you need to modify
string representation of model, but recommended way is to extend <code>Property</code>
output modifications.</p>
<p>For example:</p>
<pre class="hljs"><button data-clipboard-target="#_2dpf" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_2dpf"><span class="hljs-comment">//model's property declaration:</span>
properties: {
    <span class="hljs-attr">id</span>: Property.id(),
    <span class="hljs-attr">isbn</span>: Property.string().pattern(<span class="hljs-regexp">/^ISBN \d-\d{3}-\d{5}-\d$/</span>),
    <span class="hljs-attr">creationTime</span>: Property.date().private(),
    <span class="hljs-attr">modificationTime</span>: Property.date().private()
}

...

<span class="hljs-comment">//models instance:</span>

book.toJSON(); 
<span class="hljs-comment">// returns</span>
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//    "id": 42,</span>
<span class="hljs-comment">//    "isbn": "ISBN 4-393-29939-3"</span>
<span class="hljs-comment">// }</span>
<span class="hljs-comment">// Note, properties creationTime and modificationTime are missing</span>
<span class="hljs-comment">// because they are marked as private: Property.date().private()</span>

<span class="hljs-comment">// The same applies to JSON.stringify() for obvious reasons </span>
<span class="hljs-comment">// (https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#toJSON()_behavior)</span>
<span class="hljs-built_in">JSON</span>.stringify(book);
</code></pre>
<p><code>.save()</code></p>
<p>Saves model instance in DB. Properties validation will be performed before saving.
Returns Promise that will be resolved with model instance, or rejected with
validation or DB error. This method requires <code>repository:</code> to be defined in model declaration.</p>
<p>For example:</p>
<pre class="hljs"><button data-clipboard-target="#_6km" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_6km"> <span class="hljs-keyword">return</span> book.save();
</code></pre>
<p><code>.remove()</code></p>
<p>Removes model instance from DB. Returns Promise that will be resolved with DB response,
or rejected with DB error. This method requires <code>repository:</code> to be defined in model declaration.</p>
<p>For example:</p>
<pre class="hljs"><button data-clipboard-target="#_d5k" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_d5k"> <span class="hljs-keyword">return</span> book.remove()
    .then(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (result.affectedRows === <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">this</span>.response.status = <span class="hljs-keyword">this</span>.response.statuses._204_NoContent;
        }
    });
</code></pre>
<h3>Repositories</h3>
<p>Files containing repository declaration should export instance
of Repository (<code>core/repositories/repositoryPrototype.js</code>)
representing external storage (e.g. database) related to specific model.</p>
<p>Repository can be created using default <code>Repositories.create()</code> method
or by custom implementation of repository interface.</p>
<p>Default repository can be extended with methods that makes
direct calls to external storage, e.g. <code>findByTitle()</code>.</p>
<pre class="hljs"><button data-clipboard-target="#_pdd" title="Copy to clipboard"><svg viewBox="-40 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m271 512h-191c-44.113281 0-80-35.886719-80-80v-271c0-44.113281 35.886719-80 80-80h191c44.113281 0 80 35.886719 80 80v271c0 44.113281-35.886719 80-80 80zm-191-391c-22.054688 0-40 17.945312-40 40v271c0 22.054688 17.945312 40 40 40h191c22.054688 0 40-17.945312 40-40v-271c0-22.054688-17.945312-40-40-40zm351 261v-302c0-44.113281-35.886719-80-80-80h-222c-11.046875 0-20 8.953125-20 20s8.953125 20 20 20h222c22.054688 0 40 17.945312 40 40v302c0 11.046875 8.953125 20 20 20s20-8.953125 20-20zm0 0"/></svg></button><code class="highlight" id="_pdd"><span class="hljs-keyword">const</span> Repositories              = use(<span class="hljs-string">'core/repositories'</span>);

<span class="hljs-built_in">module</span>.exports = Repositories.create(<span class="hljs-string">'books_table'</span>, {

    findByTitle(title, offset, limit){
        <span class="hljs-keyword">const</span> query = <span class="hljs-string">`SELECT * FROM <span class="hljs-subst">${<span class="hljs-keyword">this</span>.__table__}</span> 
                       WHERE title LIKE ?
                       LIMIT ?, ?`</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.db.execute(query, [<span class="hljs-string">`%<span class="hljs-subst">${title}</span>%`</span>, offset, limit])
            .then(<span class="hljs-function">(<span class="hljs-params">[rows, columns]</span>) =&gt;</span> rows);
    }

}); 
</code></pre>
<p>Custom methods in <code>Repositories</code> should return raw data.
Any data post-processing should be performed in models or factories.</p>
<p>Default <code>Repositories</code> prototype has methods:</p>
<p><code>.find( [criteriasObject], [limit], [offset], [order] )</code></p>
<p>Executes SELECT query in DB. Used by <code>.get()</code> and <code>.find()</code> methods
in default models factories prototype.</p>
<p><code>.save( [modelInstance] )</code>
Executes INSERT or UPDATE query in DB. Used by <code>.save()</code> method
in default models instance prototype.</p>
<p><code>.remove( [modelInstance] )</code>
Executes DELETE query in DB. Used by <code>.remove()</code> method
in default models instance prototype.</p>
<p>There are very few good reasons you would need to overload this methods
or call them directly. So, take it as an interface you need to
implement in case of writing custom <code>Repository</code>.</p>
<h3>Interceptors</h3>
<p><strong>Interceptors are global!</strong> This means that no matter in what
component they are declared, they will be executed for <em>every</em> request.
I know it feels counter-intuitive and smells like a bad design, but it’s not.
Or, at least I think it is not.</p>
<p>The point here you should never need to decorate API endpoint on component level
or on single <code>handler</code> level. Such functionality should be moved to factories, models
or services.</p>
<p>Interceptors should be used for actual global things like extracting
cookies from header, parsing multipart/form-data, logging, converting response
from JSON to XML, etc.</p>
</div>
</div>
</body>
</html>
